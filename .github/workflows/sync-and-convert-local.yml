name: "Sync + æœ¬åœ°åŒ– Script-Hub è½¬æ¢ï¼ˆå¢å¼ºç‰ˆï¼Œå«å¯åŠ¨æ£€æµ‹ï¼‰"

on:
  workflow_dispatch: {}
  schedule:
    - cron: "30 2 * * *"    # æ¯å¤© UTC 02:30 è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'script-hub-list.json'
      - '.github/scripts/convert_hub_local.py'
      - '.github/scripts/sync-hub.py'   # å¦‚éœ€åŒæ­¥å…¶å®ƒè„šæœ¬ï¼Œå¯ä¿ç•™æ­¤é¡¹ï¼›å¦åˆ™å¯åˆ é™¤

jobs:
  sync_and_convert:
    runs-on: ubuntu-latest

    env:
      SCRIPT_HUB_API_BASE: "http://127.0.0.1:9100"
      GITHUB_RAW_BASE: ${{ secrets.GITHUB_RAW_BASE }}
      CLEAN_MODE: "true"
      BARK_PUSH_URL: ${{ secrets.BARK_PUSH_URL }}
      SERVERCHAN_SEND_KEY: ${{ secrets.SERVERCHAN_SEND_KEY }}
      WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
      TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
      TG_USER_ID: ${{ secrets.TG_USER_ID }}
      NOTIFY_LANG: ${{ secrets.NOTIFY_LANG }}
      FORCE_NOTIFY: ${{ secrets.FORCE_NOTIFY }}
      BARK_ICON_URL: ${{ secrets.BARK_ICON_URL }}

    steps:
      # -------------------------------------------------------------------
      # 1. Checkoutï¼šæ‹‰å–ä»“åº“å¹¶ä¿ç•™å‡­æ®ï¼Œä»¥ä¾¿åç»­ git push ä½¿ç”¨ GITHUB_TOKEN
      - name: Checkout ä»“åº“
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      # -------------------------------------------------------------------
      # 2. é…ç½® Git ç”¨æˆ·ä¿¡æ¯ï¼Œé¿å… "Please tell me who you are" é”™è¯¯
      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # -------------------------------------------------------------------
      # 3. å®‰è£… Node.jsï¼ˆâ‰¥18ï¼‰
      - name: Setup Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      # -------------------------------------------------------------------
      # 4. Clone Script-Hub åç«¯åˆ°ä¸´æ—¶ç›®å½•
      - name: æ‹‰å– Script-Hub åç«¯æºç 
        run: |
          mkdir -p /tmp/script-hub-backend
          git clone https://github.com/Script-Hub-Org/Script-Hub.git /tmp/script-hub-backend
          echo "Script-Hub åç«¯æºç å·²ä¸‹è½½åˆ° /tmp/script-hub-backend"

      # -------------------------------------------------------------------
      # 5. å¯åŠ¨ Script-Hub æœåŠ¡ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
      - name: å®‰è£… & å¯åŠ¨ Script-Hub åç«¯
        run: |
          cd /tmp/script-hub-backend
          
          # 1) æ£€æŸ¥ package.json æ–‡ä»¶å­˜åœ¨
          if [ ! -f package.json ]; then
            echo "âŒ æœªæ‰¾åˆ° package.jsonï¼Œè¯·æ£€æŸ¥ Script-Hub ä»“åº“ç»“æ„"
            exit 1
          fi
          
          # 2) å®‰è£…ä¾èµ– (ä½¿ç”¨ npm è€Œä¸æ˜¯ pnpmï¼Œé¿å…é¢å¤–ä¾èµ–)
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm install
          
          # 3) æ£€æŸ¥å¯ç”¨çš„å¯åŠ¨å‘½ä»¤
          echo "ğŸ“‹ package.json ä¸­çš„ scripts:"
          cat package.json | grep -A 10 '"scripts"'
          
          # 4) å°è¯•å¯åŠ¨æœåŠ¡ (æ ¹æ®å®é™…çš„ Script-Hub é¡¹ç›®è°ƒæ•´å¯åŠ¨å‘½ä»¤)
          echo "ğŸš€ å¯åŠ¨ Script-Hub åç«¯..."
          
          # æ–¹å¼1: å¦‚æœæœ‰ start å‘½ä»¤
          if npm run | grep -q "start"; then
            nohup npm start > /tmp/script-hub.log 2>&1 &
          # æ–¹å¼2: å¦‚æœæœ‰ serve å‘½ä»¤  
          elif npm run | grep -q "serve"; then
            nohup npm run serve > /tmp/script-hub.log 2>&1 &
          # æ–¹å¼3: ç›´æ¥è¿è¡Œä¸»æ–‡ä»¶ (éœ€è¦æ ¹æ®å®é™…é¡¹ç›®è°ƒæ•´)
          elif [ -f app.js ]; then
            nohup node app.js > /tmp/script-hub.log 2>&1 &
          elif [ -f index.js ]; then
            nohup node index.js > /tmp/script-hub.log 2>&1 &
          elif [ -f server.js ]; then
            nohup node server.js > /tmp/script-hub.log 2>&1 &
          else
            echo "âŒ æ— æ³•ç¡®å®šå¯åŠ¨æ–¹å¼ï¼Œè¯·æ£€æŸ¥ Script-Hub é¡¹ç›®"
            exit 1
          fi
          
          # è·å–åå°è¿›ç¨‹PID
          SERVER_PID=$!
          echo "Script-Hub åç«¯ PID: $SERVER_PID"
          
          # 5) ç­‰å¾…æœåŠ¡å¯åŠ¨å¹¶æ£€æµ‹ï¼ˆæœ€å¤šç­‰ 60 ç§’ï¼‰
          echo "âŒ› ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          for i in {1..12}; do
            sleep 5
            echo "æ£€æµ‹ç¬¬ $i æ¬¡..."
            
            # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "âŒ Script-Hub è¿›ç¨‹å·²é€€å‡ºï¼ŒæŸ¥çœ‹æ—¥å¿—:"
              cat /tmp/script-hub.log
              exit 1
            fi
            
            # æ£€æŸ¥æœåŠ¡æ˜¯å¦å“åº” (å°è¯•ä¸åŒçš„å¥åº·æ£€æŸ¥ç«¯ç‚¹)
            if curl -f -s http://127.0.0.1:9100/ > /dev/null 2>&1; then
              echo "âœ… Script-Hub åç«¯å·²å¯åŠ¨ (ç«¯å£ 9100)"
              break
            elif curl -f -s http://127.0.0.1:9100/health > /dev/null 2>&1; then
              echo "âœ… Script-Hub åç«¯å·²å¯åŠ¨ (ç«¯å£ 9100, /health)"
              break  
            elif curl -f -s http://127.0.0.1:9100/api > /dev/null 2>&1; then
              echo "âœ… Script-Hub åç«¯å·²å¯åŠ¨ (ç«¯å£ 9100, /api)"
              break
            fi
            
            if [ $i -eq 12 ]; then
              echo "âŒ Script-Hub åç«¯å¯åŠ¨è¶…æ—¶ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
              cat /tmp/script-hub.log
              echo "å°è¯•ç›´æ¥æµ‹è¯•è¿æ¥:"
              curl -v http://127.0.0.1:9100/ || true
              exit 1
            fi
            
            echo "ç­‰å¾…ä¸­... ($i/12)"
          done
          
          echo "ğŸ‰ Script-Hub åç«¯å¯åŠ¨æˆåŠŸ!"

      # -------------------------------------------------------------------
      # 6. å®‰è£… Pythonï¼Œç”¨äºæ‰§è¡Œè½¬æ¢è„šæœ¬
      - name: Setup Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      # -------------------------------------------------------------------
      # 7. å®‰è£… Python ä¾èµ– requests
      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # -------------------------------------------------------------------
      # 8. ï¼ˆå¯é€‰ï¼‰è¿è¡Œ sync-hub.py åŒæ­¥å…¶å®ƒè„šæœ¬åˆ°æœ¬åœ°
      #    å¦‚æœä¸éœ€è¦ï¼Œæ³¨é‡Šæˆ–åˆ é™¤ä»¥ä¸‹ä¸‰è¡Œå³å¯
      - name: è¿è¡Œ sync-hub.pyï¼ˆå¯é€‰åŒæ­¥æ­¥éª¤ï¼‰
        run: |
          if [ -f .github/scripts/sync-hub.py ]; then
            python .github/scripts/sync-hub.py
          else
            echo "sync-hub.py ä¸å­˜åœ¨ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi

      # -------------------------------------------------------------------
      # 9. è¿è¡Œæœ¬åœ°åŒ–è½¬æ¢è„šæœ¬ï¼šconvert_hub_local.py
      - name: ä» JSON è½¬æ¢å¹¶æ¨é€
        run: |
          python .github/scripts/convert_hub_local.py

      # -------------------------------------------------------------------
      # 10. ï¼ˆå¯é€‰ï¼‰æ£€æŸ¥è¾“å‡ºç›®å½•ç»“æ„ï¼Œä¾¿äºåœ¨ Actions æ—¥å¿—ä¸­æŸ¥çœ‹
      - name: æ‰“å° SCRIPT-HUB-OUTPUT ç›®å½•
        run: |
          echo "---- SCRIPT-HUB-OUTPUT ç›®å½• ----"
          if [ -d "SCRIPT-HUB-OUTPUT" ]; then
            find SCRIPT-HUB-OUTPUT -maxdepth 3 | sed 's/^/  /'
          else
            echo "  SCRIPT-HUB-OUTPUT ç›®å½•ä¸å­˜åœ¨"
          fi

      # -------------------------------------------------------------------
      # 11. æ˜¾ç¤º Script-Hub æ—¥å¿—ï¼ˆè°ƒè¯•ç”¨ï¼‰
      - name: æ˜¾ç¤º Script-Hub æ—¥å¿—
        if: always()
        run: |
          echo "---- Script-Hub æœåŠ¡æ—¥å¿— ----"
          if [ -f /tmp/script-hub.log ]; then
            cat /tmp/script-hub.log
          else
            echo "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
          fi
