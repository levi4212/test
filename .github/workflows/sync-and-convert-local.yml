name: "Script è½¬æ¢å™¨ï¼ˆä½¿ç”¨åœ¨çº¿ APIï¼‰"

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 2 * * *"    # æ¯å¤© UTC 02:00 è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'script-hub-list.json'
      - '.github/workflows/*.yml'

jobs:
  convert_scripts:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    env:
      OUTPUT_DIR: "converted-scripts"

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. é…ç½® Git
      - name: é…ç½® Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      # 3. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 4. å®‰è£… Python ä¾èµ–
      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests urllib3 pyyaml

      # 5. æ‰§è¡Œè„šæœ¬è½¬æ¢ï¼ˆä½¿ç”¨åœ¨çº¿ APIï¼‰
      - name: æ‰§è¡Œè„šæœ¬è½¬æ¢
        run: |
          python3 << 'EOF'
          import os
          import json
          import requests
          import hashlib
          import subprocess
          import time
          import re
          from pathlib import Path
          from urllib.parse import quote, urlencode

          # é…ç½®
          JSON_CONFIG = "script-hub-list.json"
          OUTPUT_DIR = "converted-scripts"
          
          # åœ¨çº¿è½¬æ¢ API åˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
          CONVERSION_APIS = [
              {
                  "name": "Script-Hub Official",
                  "base_url": "https://script.hub/file",
                  "platforms": {
                      "Surge": "Surge",
                      "Loon": "Loon", 
                      "Shadowrocket": "Shadowrocket",
                      "Stash": "Stash",
                      "Plain": "Plain"
                  }
              },
              {
                  "name": "Script-Hub Mirror 1",
                  "base_url": "https://scripthub.vercel.app/file",
                  "platforms": {
                      "Surge": "Surge",
                      "Loon": "Loon", 
                      "Shadowrocket": "Shadowrocket",
                      "Stash": "Stash",
                      "Plain": "Plain"
                  }
              }
          ]
          
          # ç›®æ ‡å¹³å°æ–‡ä»¶æ‰©å±•å
          PLATFORM_EXTENSIONS = {
              "Surge": ".sgmodule",
              "Loon": ".plugin", 
              "Shadowrocket": ".shimodule",
              "Stash": ".stoverride",
              "Plain": ".txt"
          }

          def log(msg):
              print(f"[è½¬æ¢å™¨] {msg}")

          def compute_hash(filepath):
              """è®¡ç®—æ–‡ä»¶ SHA256 å“ˆå¸Œ"""
              sha256_hash = hashlib.sha256()
              with open(filepath, "rb") as f:
                  for chunk in iter(lambda: f.read(4096), b""):
                      sha256_hash.update(chunk)
              return sha256_hash.hexdigest()

          def test_api_endpoint(api_config):
              """æµ‹è¯• API ç«¯ç‚¹æ˜¯å¦å¯ç”¨"""
              try:
                  test_url = f"{api_config['base_url']}/Surge/https://raw.githubusercontent.com/NobyDa/Script/master/Surge/JS/Bilibili_Auto_Regions.js"
                  response = requests.get(test_url, timeout=10)
                  return response.status_code == 200
              except:
                  return False

          def convert_script_with_api(name, url, platform, api_config):
              """ä½¿ç”¨æŒ‡å®š API è½¬æ¢è„šæœ¬"""
              try:
                  platform_name = api_config["platforms"].get(platform)
                  if not platform_name:
                      return None
                  
                  # æ„é€  API URL
                  api_url = f"{api_config['base_url']}/{platform_name}/{quote(url, safe='')}"
                  
                  # å‘é€è¯·æ±‚
                  response = requests.get(api_url, timeout=30)
                  response.raise_for_status()
                  
                  return response.content
              except Exception as e:
                  log(f"âŒ API {api_config['name']} è½¬æ¢å¤±è´¥ [{platform}] {name}: {e}")
                  return None

          def convert_script(name, url, platform):
              """å°è¯•ç”¨å¤šä¸ª API è½¬æ¢è„šæœ¬"""
              for api_config in CONVERSION_APIS:
                  log(f"ğŸ”„ å°è¯•ä½¿ç”¨ {api_config['name']} è½¬æ¢ [{platform}] {name}")
                  content = convert_script_with_api(name, url, platform, api_config)
                  if content:
                      log(f"âœ… ä½¿ç”¨ {api_config['name']} æˆåŠŸè½¬æ¢ [{platform}] {name}")
                      return content
                  time.sleep(1)  # é¿å…è¯·æ±‚è¿‡å¿«
              
              log(f"âŒ æ‰€æœ‰ API éƒ½æ— æ³•è½¬æ¢ [{platform}] {name}")
              return None

          def create_simple_conversion(name, url, platform):
              """åˆ›å»ºç®€å•çš„é‡å®šå‘æ–‡ä»¶ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰"""
              if platform == "Plain":
                  return f"# {name}\n# åŸå§‹é“¾æ¥: {url}\n\n# è¯·æ‰‹åŠ¨è®¿é—®ä¸Šè¿°é“¾æ¥è·å–è„šæœ¬å†…å®¹\n".encode('utf-8')
              elif platform == "Surge":
                  return f"""#!name={name}
          #!desc=Auto converted from {url}
          
          [Script]
          # è¯·æ‰‹åŠ¨é…ç½®è„šæœ¬è§„åˆ™
          # åŸå§‹é“¾æ¥: {url}
          """.encode('utf-8')
              else:
                  return f"""# {name}
          # åŸå§‹é“¾æ¥: {url}
          # å¹³å°: {platform}
          # 
          # æ³¨æ„: è‡ªåŠ¨è½¬æ¢å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é…ç½®
          """.encode('utf-8')

          def main():
              # æ£€æŸ¥é…ç½®æ–‡ä»¶
              if not os.path.exists(JSON_CONFIG):
                  log(f"âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {JSON_CONFIG}")
                  return False

              # è¯»å–é…ç½®
              try:
                  with open(JSON_CONFIG, 'r', encoding='utf-8') as f:
                      scripts = json.load(f)
              except Exception as e:
                  log(f"âŒ è¯»å–é…ç½®å¤±è´¥: {e}")
                  return False

              if not isinstance(scripts, list):
                  log("âŒ é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºæ•°ç»„")
                  return False

              # æµ‹è¯•å¯ç”¨çš„ API
              log("ğŸ” æµ‹è¯• API ç«¯ç‚¹...")
              available_apis = []
              for api_config in CONVERSION_APIS:
                  if test_api_endpoint(api_config):
                      available_apis.append(api_config)
                      log(f"âœ… {api_config['name']} å¯ç”¨")
                  else:
                      log(f"âŒ {api_config['name']} ä¸å¯ç”¨")
              
              if not available_apis:
                  log("âš ï¸ æ‰€æœ‰åœ¨çº¿ API éƒ½ä¸å¯ç”¨ï¼Œå°†åˆ›å»ºå¤‡ç”¨æ–‡ä»¶")
              else:
                  global CONVERSION_APIS
                  CONVERSION_APIS = available_apis

              # åˆ›å»ºè¾“å‡ºç›®å½•
              Path(OUTPUT_DIR).mkdir(exist_ok=True)
              for platform in PLATFORM_EXTENSIONS.keys():
                  Path(OUTPUT_DIR, platform).mkdir(exist_ok=True)

              # è®°å½•å˜æ›´
              changes = []
              
              # å¤„ç†æ¯ä¸ªè„šæœ¬
              for script in scripts:
                  name = script.get('name')
                  url = script.get('url')
                  
                  if not name or not url:
                      log(f"âš ï¸ è·³è¿‡æ— æ•ˆé…ç½®: {script}")
                      continue
                  
                  log(f"ğŸ”„ å¤„ç†è„šæœ¬: {name}")
                  
                  # è½¬æ¢åˆ°å„ä¸ªå¹³å°
                  for platform, ext in PLATFORM_EXTENSIONS.items():
                      output_file = Path(OUTPUT_DIR, platform, f"{name}{ext}")
                      
                      # è½¬æ¢è„šæœ¬
                      content = convert_script(name, url, platform)
                      
                      # å¦‚æœè½¬æ¢å¤±è´¥ï¼Œåˆ›å»ºå¤‡ç”¨æ–‡ä»¶
                      if content is None:
                          content = create_simple_conversion(name, url, platform)
                          log(f"âš ï¸ åˆ›å»ºå¤‡ç”¨æ–‡ä»¶ [{platform}] {name}")
                      
                      # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
                      should_update = True
                      if output_file.exists():
                          old_hash = compute_hash(output_file)
                          # å†™å…¥ä¸´æ—¶æ–‡ä»¶è®¡ç®—æ–°å“ˆå¸Œ
                          temp_file = output_file.with_suffix(f"{ext}.tmp")
                          with open(temp_file, 'wb') as f:
                              f.write(content)
                          new_hash = compute_hash(temp_file)
                          
                          if old_hash == new_hash:
                              temp_file.unlink()  # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
                              should_update = False
                              log(f"â­ï¸  æ— å˜åŒ– [{platform}] {name}")
                          else:
                              temp_file.replace(output_file)  # æ›¿æ¢åŸæ–‡ä»¶
                              changes.append(f"update({platform}): {name}{ext}")
                              log(f"âœ… æ›´æ–° [{platform}] {name}")
                      else:
                          # æ–°æ–‡ä»¶
                          with open(output_file, 'wb') as f:
                              f.write(content)
                          changes.append(f"add({platform}): {name}{ext}")
                          log(f"â• æ–°å¢ [{platform}] {name}")
                      
                      # çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…è¯·æ±‚è¿‡å¿«
                      time.sleep(0.5)

              # æäº¤å˜æ›´
              if changes:
                  try:
                      subprocess.run(['git', 'add', OUTPUT_DIR], check=True)
                      commit_msg = f"è‡ªåŠ¨è½¬æ¢æ›´æ–° ({len(changes)} ä¸ªæ–‡ä»¶)\n\n" + "\n".join(changes)
                      subprocess.run(['git', 'commit', '-m', commit_msg], check=True)
                      log(f"âœ… æäº¤äº† {len(changes)} ä¸ªå˜æ›´")
                      return True
                  except subprocess.CalledProcessError as e:
                      log(f"âŒ Git æ“ä½œå¤±è´¥: {e}")
                      return False
              else:
                  log("â„¹ï¸  æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´")
                  return True

          if __name__ == "__main__":
              success = main()
              if not success:
                  exit(1)
          EOF

      # 6. æ¨é€å˜æ›´
      - name: æ¨é€æ›´æ–°
        run: |
          if git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰å˜æ›´éœ€è¦æ¨é€"
          else
            echo "ğŸ“¤ æ¨é€å˜æ›´åˆ°ä»“åº“..."
            git push
            echo "âœ… æ¨é€å®Œæˆ"
          fi

      # 7. ç”Ÿæˆä½¿ç”¨æŒ‡å—
      - name: ç”Ÿæˆä½¿ç”¨æŒ‡å—
        run: |
          if [ -d "$OUTPUT_DIR" ]; then
            echo "ğŸ“Š ç”Ÿæˆä½¿ç”¨æŒ‡å—..."
            python3 << 'EOF'
          import os
          import json
          from pathlib import Path
          from datetime import datetime

          OUTPUT_DIR = "converted-scripts"
          REPO_URL = os.environ.get('GITHUB_SERVER_URL', 'https://github.com') + '/' + os.environ.get('GITHUB_REPOSITORY', '')
          BRANCH = os.environ.get('GITHUB_REF_NAME', 'main')

          # è¯»å–è„šæœ¬åˆ—è¡¨
          scripts = []
          if os.path.exists('script-hub-list.json'):
              with open('script-hub-list.json', 'r', encoding='utf-8') as f:
                  scripts = json.load(f)

          # ç”Ÿæˆ README
          readme_content = f"""# è„šæœ¬è½¬æ¢ç»“æœ

          æœ¬ä»“åº“è‡ªåŠ¨è½¬æ¢è„šæœ¬ä¸ºå„ä»£ç†å·¥å…·æ ¼å¼ï¼Œæ¯æ—¥è‡ªåŠ¨æ›´æ–°ã€‚

          ## ğŸ“± æ”¯æŒå¹³å°

          - **Surge**: `.sgmodule` æ¨¡å—æ ¼å¼
          - **Loon**: `.plugin` æ’ä»¶æ ¼å¼  
          - **Shadowrocket**: `.shimodule` æ¨¡å—æ ¼å¼
          - **Stash**: `.stoverride` è¦†å†™æ ¼å¼
          - **Plain**: `.txt` çº¯æ–‡æœ¬æ ¼å¼

          ## ğŸ”— ä½¿ç”¨æ–¹æ³•

          ç‚¹å‡»ä¸‹æ–¹å¯¹åº”å¹³å°çš„é“¾æ¥ï¼Œå¤åˆ¶ Raw URL åˆ°ä½ çš„ä»£ç†å·¥å…·ä¸­ï¼š

          """

          for script in scripts:
              name = script.get('name', '')
              original_url = script.get('url', '')
              if not name:
                  continue
                  
              readme_content += f"\n### {name}\n\n"
              readme_content += f"**åŸå§‹é“¾æ¥**: {original_url}\n\n"
              
              platforms = {
                  "Surge": ".sgmodule",
                  "Loon": ".plugin", 
                  "Shadowrocket": ".shimodule",
                  "Stash": ".stoverride",
                  "Plain": ".txt"
              }
              
              for platform, ext in platforms.items():
                  file_path = f"{OUTPUT_DIR}/{platform}/{name}{ext}"
                  if os.path.exists(file_path):
                      raw_url = f"{REPO_URL}/raw/{BRANCH}/{file_path}"
                      readme_content += f"- **{platform}**: [`{name}{ext}`]({raw_url})\n"

          readme_content += f"""

          ## ğŸ”„ æ›´æ–°é¢‘ç‡

          - æ¯æ—¥ UTC 02:00 è‡ªåŠ¨æ£€æŸ¥æ›´æ–°
          - é…ç½®æ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨è§¦å‘è½¬æ¢
          - æ”¯æŒæ‰‹åŠ¨è§¦å‘è½¬æ¢

          ## ğŸ“‹ è„šæœ¬ç»Ÿè®¡

          - è„šæœ¬æ€»æ•°: **{len(scripts)}** ä¸ª
          - æ”¯æŒå¹³å°: **5** ä¸ª

          ## âš ï¸ ä½¿ç”¨è¯´æ˜

          1. éƒ¨åˆ†è„šæœ¬å¯èƒ½éœ€è¦æ‰‹åŠ¨é…ç½®å‚æ•°
          2. å¦‚æœè½¬æ¢å¤±è´¥ï¼Œä¼šç”ŸæˆåŒ…å«åŸå§‹é“¾æ¥çš„å¤‡ç”¨æ–‡ä»¶
          3. å»ºè®®ä¼˜å…ˆä½¿ç”¨ Surgeã€Loon ç­‰ä¸»æµå¹³å°çš„è½¬æ¢ç»“æœ

          ## ğŸ”§ æ·»åŠ æ–°è„šæœ¬

          ç¼–è¾‘ `script-hub-list.json` æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹æ ¼å¼çš„é…ç½®ï¼š

          ```json
          [
            {{
              "name": "è„šæœ¬åç§°",
              "url": "https://åŸå§‹è„šæœ¬é“¾æ¥"
            }}
          ]
          ```

          ---
          
          *æœ€åæ›´æ–°: {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')} UTC*  
          *ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
          """

          # å†™å…¥ README
          with open(f'{OUTPUT_DIR}/README.md', 'w', encoding='utf-8') as f:
              f.write(readme_content)

          print("âœ… ä½¿ç”¨æŒ‡å—å·²ç”Ÿæˆ")
          EOF
          fi

      # 8. æ˜¾ç¤ºç»“æœç»Ÿè®¡
      - name: æ˜¾ç¤ºè½¬æ¢ç»“æœ
        run: |
          echo "ğŸ“Š è½¬æ¢ç»“æœç»Ÿè®¡:"
          if [ -d "$OUTPUT_DIR" ]; then
            total_files=0
            for platform in Surge Loon Shadowrocket Stash Plain; do
              if [ -d "$OUTPUT_DIR/$platform" ]; then
                count=$(find "$OUTPUT_DIR/$platform" -name "*.*" -type f | wc -l)
                echo "  $platform: $count ä¸ªæ–‡ä»¶"
                total_files=$((total_files + count))
              fi
            done
            
            echo "  æ€»è®¡: $total_files ä¸ªæ–‡ä»¶"
            echo ""
            echo "ğŸ”— è®¿é—®é“¾æ¥æ¨¡æ¿:"
            echo "  https://raw.githubusercontent.com/$GITHUB_REPOSITORY/$GITHUB_REF_NAME/$OUTPUT_DIR/[å¹³å°]/[è„šæœ¬å][æ‰©å±•å]"
            
            echo ""
            echo "ğŸ“ è¾“å‡ºç›®å½•ç»“æ„:"
            if command -v tree >/dev/null; then
              tree "$OUTPUT_DIR" -L 2
            else
              find "$OUTPUT_DIR" -type f | head -20
            fi
          else
            echo "âŒ è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
          fi
