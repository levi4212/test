name: "Sync + æœ¬åœ°åŒ– Script-Hub è½¬æ¢ï¼ˆå¢å¼ºç‰ˆï¼Œå«å¯åŠ¨æ£€æµ‹ï¼‰"

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 2 * * *"    # æ¯å¤© UTC 02:00 è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'script-hub-list.json'
      - '.github/workflows/*.yml'

jobs:
  convert_and_host:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥æ¨é€æ–‡ä»¶

    env:
      SCRIPT_HUB_PORT: 9100
      OUTPUT_DIR: "converted-scripts"

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. é…ç½® Git
      - name: é…ç½® Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      # 3. è®¾ç½® Node.js ç¯å¢ƒï¼ˆç§»é™¤ç¼“å­˜é…ç½®ï¼‰
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # ç§»é™¤ cache: 'npm' è¿™ä¸€è¡Œï¼Œå› ä¸ºå½“å‰ä»“åº“æ²¡æœ‰ package-lock.json

      # 4. ä¸‹è½½å¹¶è®¾ç½® Script-Hub
      - name: ä¸‹è½½ Script-Hub åç«¯
        run: |
          echo "ğŸ“¥ ä¸‹è½½ Script-Hub æºç ..."
          git clone --depth=1 https://github.com/Script-Hub-Org/Script-Hub.git /tmp/script-hub
          cd /tmp/script-hub
          
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm install --production
          
          echo "âœ… Script-Hub åç«¯å‡†å¤‡å®Œæˆ"

      # 5. å¯åŠ¨ Script-Hub æœåŠ¡
      - name: å¯åŠ¨ Script-Hub åç«¯
        run: |
          cd /tmp/script-hub
          
          # æŸ¥çœ‹å¯ç”¨çš„å¯åŠ¨å‘½ä»¤
          echo "ğŸ“‹ æ£€æŸ¥ package.json è„šæœ¬..."
          if [ -f package.json ]; then
            npm run 2>&1 | grep -E "^  " || echo "æœªæ‰¾åˆ°é¢„å®šä¹‰è„šæœ¬"
          fi
          
          # æŸ¥æ‰¾ä¸»å…¥å£æ–‡ä»¶
          MAIN_FILE=""
          if [ -f package.json ] && grep -q '"main"' package.json; then
            MAIN_FILE=$(node -e "console.log(require('./package.json').main || '')")
          fi
          
          # æŒ‰ä¼˜å…ˆçº§å°è¯•å¯åŠ¨
          echo "ğŸš€ å¯åŠ¨ Script-Hub æœåŠ¡..."
          if npm run start --if-present 2>/dev/null; then
            echo "ä½¿ç”¨ npm start å¯åŠ¨"
            nohup npm start > /tmp/script-hub.log 2>&1 &
          elif [ -n "$MAIN_FILE" ] && [ -f "$MAIN_FILE" ]; then
            echo "ä½¿ç”¨ä¸»æ–‡ä»¶å¯åŠ¨: $MAIN_FILE"
            nohup node "$MAIN_FILE" > /tmp/script-hub.log 2>&1 &
          elif [ -f "app.js" ]; then
            echo "ä½¿ç”¨ app.js å¯åŠ¨"
            nohup node app.js > /tmp/script-hub.log 2>&1 &
          elif [ -f "index.js" ]; then
            echo "ä½¿ç”¨ index.js å¯åŠ¨"
            nohup node index.js > /tmp/script-hub.log 2>&1 &
          elif [ -f "server.js" ]; then
            echo "ä½¿ç”¨ server.js å¯åŠ¨"
            nohup node server.js > /tmp/script-hub.log 2>&1 &
          else
            echo "âŒ æ— æ³•æ‰¾åˆ°å¯åŠ¨å…¥å£"
            ls -la
            exit 1
          fi
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          for i in {1..30}; do
            sleep 2
            if curl -s http://127.0.0.1:$SCRIPT_HUB_PORT >/dev/null 2>&1; then
              echo "âœ… Script-Hub æœåŠ¡å·²å¯åŠ¨ (ç«¯å£ $SCRIPT_HUB_PORT)"
              break
            elif curl -s http://127.0.0.1:$SCRIPT_HUB_PORT/health >/dev/null 2>&1; then
              echo "âœ… Script-Hub æœåŠ¡å·²å¯åŠ¨ (ç«¯å£ $SCRIPT_HUB_PORT)"
              break
            fi
            
            if [ $i -eq 30 ]; then
              echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶"
              echo "=== æœåŠ¡æ—¥å¿— ==="
              cat /tmp/script-hub.log 2>/dev/null || echo "æ— æ—¥å¿—æ–‡ä»¶"
              echo "=== ç½‘ç»œæ£€æŸ¥ ==="
              netstat -tlnp | grep :$SCRIPT_HUB_PORT || echo "ç«¯å£æœªç›‘å¬"
              exit 1
            fi
            
            echo "ç­‰å¾…ä¸­... ($i/30)"
          done

      # 6. è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 7. å®‰è£… Python ä¾èµ–
      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests urllib3

      # 8. æ‰§è¡Œè½¬æ¢è„šæœ¬
      - name: æ‰§è¡Œè„šæœ¬è½¬æ¢
        run: |
          python3 << 'EOF'
          import os
          import json
          import requests
          import hashlib
          import subprocess
          from pathlib import Path
          from urllib.parse import quote_plus
          import time

          # é…ç½®
          JSON_CONFIG = "script-hub-list.json"
          OUTPUT_DIR = "converted-scripts"
          API_BASE = "http://127.0.0.1:9100"
          
          # ç›®æ ‡å¹³å°é…ç½®
          PLATFORMS = {
              "Surge": ".sgmodule",
              "Loon": ".plugin", 
              "Shadowrocket": ".shimodule",
              "Stash": ".stoverride",
              "Plain": ".txt"
          }

          def log(msg):
              print(f"[è½¬æ¢å™¨] {msg}")

          def compute_hash(filepath):
              """è®¡ç®—æ–‡ä»¶ SHA256 å“ˆå¸Œ"""
              sha256_hash = hashlib.sha256()
              with open(filepath, "rb") as f:
                  for chunk in iter(lambda: f.read(4096), b""):
                      sha256_hash.update(chunk)
              return sha256_hash.hexdigest()

          def convert_script(name, url, platform):
              """è½¬æ¢å•ä¸ªè„šæœ¬"""
              try:
                  # æ„é€  API URL
                  api_url = f"{API_BASE}/file/{platform}/{quote_plus(url)}"
                  
                  # å‘é€è¯·æ±‚
                  response = requests.get(api_url, timeout=30)
                  response.raise_for_status()
                  
                  return response.content
              except Exception as e:
                  log(f"âŒ è½¬æ¢å¤±è´¥ [{platform}] {name}: {e}")
                  return None

          def main():
              # æ£€æŸ¥é…ç½®æ–‡ä»¶
              if not os.path.exists(JSON_CONFIG):
                  log(f"âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: {JSON_CONFIG}")
                  return False

              # è¯»å–é…ç½®
              try:
                  with open(JSON_CONFIG, 'r', encoding='utf-8') as f:
                      scripts = json.load(f)
              except Exception as e:
                  log(f"âŒ è¯»å–é…ç½®å¤±è´¥: {e}")
                  return False

              if not isinstance(scripts, list):
                  log("âŒ é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºæ•°ç»„")
                  return False

              # åˆ›å»ºè¾“å‡ºç›®å½•
              Path(OUTPUT_DIR).mkdir(exist_ok=True)
              for platform in PLATFORMS.keys():
                  Path(OUTPUT_DIR, platform).mkdir(exist_ok=True)

              # è®°å½•å˜æ›´
              changes = []
              
              # å¤„ç†æ¯ä¸ªè„šæœ¬
              for script in scripts:
                  name = script.get('name')
                  url = script.get('url')
                  
                  if not name or not url:
                      log(f"âš ï¸ è·³è¿‡æ— æ•ˆé…ç½®: {script}")
                      continue
                  
                  log(f"ğŸ”„ å¤„ç†è„šæœ¬: {name}")
                  
                  # è½¬æ¢åˆ°å„ä¸ªå¹³å°
                  for platform, ext in PLATFORMS.items():
                      output_file = Path(OUTPUT_DIR, platform, f"{name}{ext}")
                      
                      # è½¬æ¢è„šæœ¬
                      content = convert_script(name, url, platform)
                      if content is None:
                          continue
                      
                      # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
                      should_update = True
                      if output_file.exists():
                          old_hash = compute_hash(output_file)
                          # å†™å…¥ä¸´æ—¶æ–‡ä»¶è®¡ç®—æ–°å“ˆå¸Œ
                          temp_file = output_file.with_suffix(f"{ext}.tmp")
                          with open(temp_file, 'wb') as f:
                              f.write(content)
                          new_hash = compute_hash(temp_file)
                          
                          if old_hash == new_hash:
                              temp_file.unlink()  # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
                              should_update = False
                              log(f"â­ï¸  æ— å˜åŒ– [{platform}] {name}")
                          else:
                              temp_file.replace(output_file)  # æ›¿æ¢åŸæ–‡ä»¶
                              changes.append(f"update({platform}): {name}{ext}")
                              log(f"âœ… æ›´æ–° [{platform}] {name}")
                      else:
                          # æ–°æ–‡ä»¶
                          with open(output_file, 'wb') as f:
                              f.write(content)
                          changes.append(f"add({platform}): {name}{ext}")
                          log(f"â• æ–°å¢ [{platform}] {name}")

              # æäº¤å˜æ›´
              if changes:
                  try:
                      subprocess.run(['git', 'add', OUTPUT_DIR], check=True)
                      commit_msg = f"è‡ªåŠ¨è½¬æ¢æ›´æ–° ({len(changes)} ä¸ªæ–‡ä»¶)\n\n" + "\n".join(changes)
                      subprocess.run(['git', 'commit', '-m', commit_msg], check=True)
                      log(f"âœ… æäº¤äº† {len(changes)} ä¸ªå˜æ›´")
                      return True
                  except subprocess.CalledProcessError as e:
                      log(f"âŒ Git æ“ä½œå¤±è´¥: {e}")
                      return False
              else:
                  log("â„¹ï¸  æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´")
                  return True

          if __name__ == "__main__":
              success = main()
              if not success:
                  exit(1)
          EOF

      # 9. æ¨é€å˜æ›´
      - name: æ¨é€æ›´æ–°
        run: |
          if git diff --staged --quiet; then
            echo "ğŸ“ æ²¡æœ‰å˜æ›´éœ€è¦æ¨é€"
          else
            echo "ğŸ“¤ æ¨é€å˜æ›´åˆ°ä»“åº“..."
            git push
            echo "âœ… æ¨é€å®Œæˆ"
          fi

      # 10. ç”Ÿæˆä½¿ç”¨æŒ‡å—
      - name: ç”Ÿæˆä½¿ç”¨æŒ‡å—
        run: |
          if [ -d "$OUTPUT_DIR" ]; then
            echo "ğŸ“Š ç”Ÿæˆä½¿ç”¨æŒ‡å—..."
            python3 << 'EOF'
          import os
          import json
          from pathlib import Path

          OUTPUT_DIR = "converted-scripts"
          REPO_URL = os.environ.get('GITHUB_SERVER_URL', 'https://github.com') + '/' + os.environ.get('GITHUB_REPOSITORY', '')
          BRANCH = os.environ.get('GITHUB_REF_NAME', 'main')

          # è¯»å–è„šæœ¬åˆ—è¡¨
          scripts = []
          if os.path.exists('script-hub-list.json'):
              with open('script-hub-list.json', 'r', encoding='utf-8') as f:
                  scripts = json.load(f)

          # ç”Ÿæˆ README
          readme_content = f"""# Script-Hub è½¬æ¢ç»“æœ

          æœ¬ä»“åº“è‡ªåŠ¨è½¬æ¢è„šæœ¬ä¸ºå„å¹³å°æ ¼å¼ï¼Œæ¯æ—¥è‡ªåŠ¨æ›´æ–°ã€‚

          ## ğŸ“± æ”¯æŒå¹³å°

          - **Surge**: `.sgmodule` æ ¼å¼
          - **Loon**: `.plugin` æ ¼å¼  
          - **Shadowrocket**: `.shimodule` æ ¼å¼
          - **Stash**: `.stoverride` æ ¼å¼
          - **Plain**: `.txt` çº¯æ–‡æœ¬æ ¼å¼

          ## ğŸ”— ä½¿ç”¨æ–¹æ³•

          ç›´æ¥å¤åˆ¶ä¸‹æ–¹å¯¹åº”å¹³å°çš„ Raw é“¾æ¥åˆ°ä½ çš„ä»£ç†å·¥å…·ä¸­ï¼š

          """

          for script in scripts:
              name = script.get('name', '')
              if not name:
                  continue
                  
              readme_content += f"\n### {name}\n\n"
              
              platforms = {
                  "Surge": ".sgmodule",
                  "Loon": ".plugin", 
                  "Shadowrocket": ".shimodule",
                  "Stash": ".stoverride",
                  "Plain": ".txt"
              }
              
              for platform, ext in platforms.items():
                  file_path = f"{OUTPUT_DIR}/{platform}/{name}{ext}"
                  if os.path.exists(file_path):
                      raw_url = f"{REPO_URL}/raw/{BRANCH}/{file_path}"
                      readme_content += f"- **{platform}**: [`{name}{ext}`]({raw_url})\n"

          readme_content += f"""
          ## ğŸ”„ æ›´æ–°é¢‘ç‡

          - æ¯æ—¥ UTC 02:00 è‡ªåŠ¨æ£€æŸ¥æ›´æ–°
          - è„šæœ¬æºæ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨è§¦å‘è½¬æ¢
          - æ”¯æŒæ‰‹åŠ¨è§¦å‘è½¬æ¢

          ## ğŸ“‹ è„šæœ¬åˆ—è¡¨

          å½“å‰è½¬æ¢çš„è„šæœ¬æ•°é‡: **{len(scripts)}** ä¸ª

          ---
          
          *æœ€åæ›´æ–°: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*
          *ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
          """

          # å†™å…¥ README
          with open(f'{OUTPUT_DIR}/README.md', 'w', encoding='utf-8') as f:
              f.write(readme_content)

          print("âœ… ä½¿ç”¨æŒ‡å—å·²ç”Ÿæˆ")
          EOF
          fi

      # 11. æ˜¾ç¤ºç»“æœç»Ÿè®¡
      - name: æ˜¾ç¤ºè½¬æ¢ç»“æœ
        run: |
          echo "ğŸ“Š è½¬æ¢ç»“æœç»Ÿè®¡:"
          if [ -d "$OUTPUT_DIR" ]; then
            for platform in Surge Loon Shadowrocket Stash Plain; do
              if [ -d "$OUTPUT_DIR/$platform" ]; then
                count=$(find "$OUTPUT_DIR/$platform" -name "*.*" -type f | wc -l)
                echo "  $platform: $count ä¸ªæ–‡ä»¶"
              fi
            done
            
            echo ""
            echo "ğŸ”— Raw æ–‡ä»¶è®¿é—®åŸºç¡€ URL:"
            echo "  https://raw.githubusercontent.com/$GITHUB_REPOSITORY/$GITHUB_REF_NAME/$OUTPUT_DIR/"
            
            echo ""
            echo "ğŸ“ ç›®å½•ç»“æ„:"
            tree "$OUTPUT_DIR" 2>/dev/null || find "$OUTPUT_DIR" -type f | head -20
          else
            echo "âŒ è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
          fi

      # 12. æ¸…ç†å’Œé”™è¯¯å¤„ç†
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -rf /tmp/script-hub* 2>/dev/null || true
          
          if [ -f /tmp/script-hub.log ]; then
            echo "ğŸ“‹ Script-Hub æœåŠ¡æ—¥å¿—:"
            tail -50 /tmp/script-hub.log
          fi
